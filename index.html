<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joinery - Smart Quote Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f172a',    // Slate 900
                            primary: '#3b82f6', // Blue 500
                            accent: '#06b6d4',  // Cyan 500
                            surface: '#ffffff',
                            light: '#f8fafc'    // Slate 50
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f1f5f9; }
        
        /* Chart Container (Mandatory) */
        .chart-container {
            position: relative;
            width: 100%;
            height: 250px;
            max-height: 300px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 1rem;
        }
        
        .input-field {
            transition: all 0.2s;
        }
        .input-field:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div class="min-h-screen flex flex-col">
        
        <!-- HEADER -->
        <header class="bg-brand-dark text-white pt-12 pb-24 px-6 rounded-b-[3rem] shadow-2xl relative overflow-hidden z-0">
            <div class="absolute top-0 right-0 p-12 opacity-5">
                <i data-lucide="hammer" class="w-64 h-64"></i>
            </div>
            <div class="max-w-7xl mx-auto flex justify-between items-end relative z-10">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="bg-brand-accent p-2 rounded-lg"><i data-lucide="calculator" class="w-6 h-6 text-white"></i></div>
                        <span class="font-display text-brand-accent tracking-wider text-sm uppercase">Profit Engine v2.0</span>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-display font-bold text-white mb-2">Quote Command</h1>
                    <p class="text-slate-400 text-lg">Manage your joinery estimates with precision.</p>
                </div>
                <div class="hidden md:block text-right">
                    <div class="text-sm text-slate-400 uppercase tracking-widest font-bold mb-1">Total Pipeline Value</div>
                    <div class="text-4xl font-display font-bold text-brand-accent" id="header-total">£0.00</div>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <!-- Added 'relative z-20' to ensure this sits ON TOP of the header's bottom curve -->
        <main class="relative z-20 max-w-7xl mx-auto px-4 -mt-16 grid lg:grid-cols-12 gap-8 pb-12 w-full">

            <!-- LEFT: INPUT (4 cols) -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-card p-6 md:p-8 animate-slide-up">
                    <h2 class="text-xl font-display font-bold text-brand-dark mb-6 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-5 h-5 text-brand-primary"></i> New Estimate
                    </h2>
                    
                    <form id="quote-form" class="space-y-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Client / Job Reference</label>
                            <div class="relative">
                                <i data-lucide="user" class="absolute left-3 top-3 w-5 h-5 text-slate-400"></i>
                                <input type="text" id="client-name" class="input-field w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20" placeholder="e.g. Smith Kitchen Reno" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Materials (£)</label>
                                <input type="number" id="materials-cost" min="0" step="0.01" class="input-field w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20" placeholder="0.00" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Hours</label>
                                <input type="number" id="labour-hours" min="0" step="0.5" class="input-field w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20" placeholder="0" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Rate (£/hr)</label>
                                <input type="number" id="hourly-rate" min="0" step="0.01" value="40" class="input-field w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Margin (%)</label>
                                <input type="number" id="profit-margin" min="0" value="20" class="input-field w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20" required>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-gradient-to-r from-brand-primary to-brand-accent hover:from-blue-600 hover:to-cyan-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30 transition-all transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2">
                            <i data-lucide="calculator" class="w-5 h-5"></i> Calculate & Add
                        </button>
                    </form>
                </div>

                <!-- Quick Stats Mini-Card -->
                <div class="glass-card p-6 bg-brand-dark text-white">
                    <h3 class="text-sm font-bold text-slate-400 uppercase mb-4">Efficiency Metrics</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-2xl font-display font-bold text-brand-accent" id="avg-margin">0%</div>
                            <div class="text-xs text-slate-400">Avg. Margin</div>
                        </div>
                        <div>
                            <div class="text-2xl font-display font-bold text-white" id="total-jobs">0</div>
                            <div class="text-xs text-slate-400">Active Jobs</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: DASHBOARD (8 cols) -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Analytics Section -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="glass-card p-6 flex flex-col">
                        <h3 class="font-bold text-slate-700 mb-4 flex justify-between items-center">
                            <span>Cost vs Profit Breakdown</span>
                            <i data-lucide="pie-chart" class="w-4 h-4 text-slate-400"></i>
                        </h3>
                        <div class="chart-container flex-1">
                            <canvas id="breakdownChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-card p-6 flex flex-col">
                        <h3 class="font-bold text-slate-700 mb-4 flex justify-between items-center">
                            <span>Recent Activity</span>
                            <button id="export-csv" class="text-xs font-bold text-brand-primary hover:text-brand-dark flex items-center gap-1 px-3 py-1 rounded-full bg-blue-50 hover:bg-blue-100 transition-colors">
                                <i data-lucide="download" class="w-3 h-3"></i> CSV
                            </button>
                        </h3>
                        <!-- Empty State -->
                        <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-center py-10 opacity-50">
                            <div class="bg-slate-100 p-4 rounded-full mb-3">
                                <i data-lucide="clipboard-list" class="w-8 h-8 text-slate-400"></i>
                            </div>
                            <p class="text-sm font-medium text-slate-500">No quotes generated yet.</p>
                            <p class="text-xs text-slate-400">Use the form to add your first job.</p>
                        </div>
                        
                        <!-- List Container -->
                        <div id="quote-list" class="hidden space-y-3 overflow-y-auto max-h-[250px] pr-2">
                            <!-- Dynamic Items -->
                        </div>
                    </div>
                </div>

                <!-- Detailed Table -->
                <div class="glass-card overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 bg-white/50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700">Detailed Breakdown</h3>
                        <div class="flex gap-2">
                             <span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold">VAT: 20%</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-xs uppercase font-bold text-slate-500">
                                <tr>
                                    <th class="px-6 py-4">Client</th>
                                    <th class="px-6 py-4 text-right">Materials</th>
                                    <th class="px-6 py-4 text-right">Labour</th>
                                    <th class="px-6 py-4 text-right text-brand-primary">Profit</th>
                                    <th class="px-6 py-4 text-right font-bold text-slate-800">Total (Inc VAT)</th>
                                    <th class="px-6 py-4"></th>
                                </tr>
                            </thead>
                            <tbody id="quote-table-body" class="divide-y divide-slate-100">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // --- STATE ---
        let quotes = [];
        let chartInstance = null;

        // --- ELEMENTS ---
        const form = document.getElementById('quote-form');
        const listContainer = document.getElementById('quote-list');
        const tableBody = document.getElementById('quote-table-body');
        const emptyState = document.getElementById('empty-state');
        const headerTotal = document.getElementById('header-total');
        const avgMarginDisplay = document.getElementById('avg-margin');
        const totalJobsDisplay = document.getElementById('total-jobs');
        const exportBtn = document.getElementById('export-csv');

        // --- HELPERS ---
        const formatGBP = (val) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(val);

        // --- CORE LOGIC ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // 1. Get Values
            const client = document.getElementById('client-name').value;
            const matCost = parseFloat(document.getElementById('materials-cost').value);
            const hours = parseFloat(document.getElementById('labour-hours').value);
            const rate = parseFloat(document.getElementById('hourly-rate').value);
            const margin = parseFloat(document.getElementById('profit-margin').value);

            // 2. Calculate
            const labourCost = hours * rate;
            const subtotalCost = matCost + labourCost;
            const profit = subtotalCost * (margin / 100);
            const netTotal = subtotalCost + profit;
            const vat = netTotal * 0.20;
            const grandTotal = netTotal + vat;

            // 3. Create Object
            const quote = {
                id: Date.now(),
                client,
                matCost,
                labourCost,
                profit,
                grandTotal,
                margin
            };

            // 4. Update State
            quotes.unshift(quote); // Add to top
            updateUI();
            form.reset();
            // Keep defaults
            document.getElementById('hourly-rate').value = 40;
            document.getElementById('profit-margin').value = 20;
        });

        function deleteQuote(id) {
            quotes = quotes.filter(q => q.id !== id);
            updateUI();
        }

        // --- RENDERING ---
        function updateUI() {
            // 1. Toggle Empty State
            if (quotes.length > 0) {
                emptyState.classList.add('hidden');
                listContainer.classList.remove('hidden');
            } else {
                emptyState.classList.remove('hidden');
                listContainer.classList.add('hidden');
            }

            // 2. Render Lists & Tables
            renderList();
            renderTable();
            
            // 3. Update Stats
            const totalValue = quotes.reduce((sum, q) => sum + q.grandTotal, 0);
            headerTotal.innerText = formatGBP(totalValue);
            totalJobsDisplay.innerText = quotes.length;
            
            const avgM = quotes.length ? (quotes.reduce((sum, q) => sum + q.margin, 0) / quotes.length).toFixed(1) : 0;
            avgMarginDisplay.innerText = avgM + '%';

            // 4. Update Chart
            updateChart();
            
            lucide.createIcons();
        }

        function renderList() {
            listContainer.innerHTML = '';
            // Only show top 4 recent
            quotes.slice(0, 4).forEach(q => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-slate-100 p-3 rounded-xl flex justify-between items-center hover:shadow-md transition-shadow';
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-brand-light flex items-center justify-center text-brand-primary font-bold text-xs">
                            ${q.client.substring(0,2).toUpperCase()}
                        </div>
                        <div>
                            <div class="font-bold text-sm text-slate-700">${q.client}</div>
                            <div class="text-xs text-slate-400">Profit: ${formatGBP(q.profit)}</div>
                        </div>
                    </div>
                    <div class="font-display font-bold text-slate-800">${formatGBP(q.grandTotal)}</div>
                `;
                listContainer.appendChild(div);
            });
        }

        function renderTable() {
            tableBody.innerHTML = '';
            quotes.forEach(q => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors group';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-800">${q.client}</td>
                    <td class="px-6 py-4 text-right text-slate-500">${formatGBP(q.matCost)}</td>
                    <td class="px-6 py-4 text-right text-slate-500">${formatGBP(q.labourCost)}</td>
                    <td class="px-6 py-4 text-right font-bold text-emerald-600">+${formatGBP(q.profit)}</td>
                    <td class="px-6 py-4 text-right font-display font-bold text-slate-900">${formatGBP(q.grandTotal)}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="deleteQuote(${q.id})" class="text-slate-300 hover:text-red-500 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // --- CHART.JS LOGIC ---
        function updateChart() {
            const ctx = document.getElementById('breakdownChart').getContext('2d');
            
            // Aggregate Data
            const totalMat = quotes.reduce((sum, q) => sum + q.matCost, 0);
            const totalLab = quotes.reduce((sum, q) => sum + q.labourCost, 0);
            const totalProf = quotes.reduce((sum, q) => sum + q.profit, 0);

            const data = {
                labels: ['Materials', 'Labour', 'Profit'],
                datasets: [{
                    data: [totalMat, totalLab, totalProf],
                    backgroundColor: ['#94a3b8', '#3b82f6', '#06b6d4'], // Slate, Blue, Cyan
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            };

            if (chartInstance) {
                chartInstance.data = data;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed !== null) label += formatGBP(context.parsed);
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // --- CSV EXPORT ---
        exportBtn.addEventListener('click', () => {
            if (quotes.length === 0) return alert("No data to export!");
            
            let csv = "Client,Materials,Labour Cost,Profit,Total (Inc VAT)\n";
            quotes.forEach(q => {
                csv += `"${q.client}",${q.matCost},${q.labourCost},${q.profit},${q.grandTotal}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cgh_quotes.csv';
            a.click();
        });

    </script>
</body>
</html>
